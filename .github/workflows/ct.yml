name: GenAI - Continuous Training (CT)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      do_finetune:
        description: 'Run finetune in this CT run? (true/false)'
        required: false
        default: 'false'
  schedule:
    - cron: '0 3 * * *'  # daily at 03:00 UTC

permissions:
  contents: read

env:
  PYTHONUNBUFFERED: 1

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      do_finetune: ${{ steps.set.outputs.do_finetune }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc

      - name: Determine whether to run fine-tune
        id: set
        run: |
          INPUT="${{ github.event.inputs.do_finetune || '' }}"
          if [ "$INPUT" != "" ] && [ "$INPUT" != "false" ]; then
            echo "do_finetune=true" >> $GITHUB_OUTPUT
          elif [ "${{ secrets.RUN_FINETUNE }}" = "true" ]; then
            echo "do_finetune=true" >> $GITHUB_OUTPUT
          else
            echo "do_finetune=false" >> $GITHUB_OUTPUT
          fi

  reproduce:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install faiss-cpu

      - name: DVC pull (optional)
        if: ${{ secrets.DVC_REMOTE_URL != '' }}
        run: |
          dvc pull || echo "dvc pull failed or nothing to pull"

      - name: Reproduce pipeline (no finetune)
        run: |
          dvc repro gen_prep gen_embeddings gen_index gen_eval || true

      - name: Run evaluation
        run: |
          python src/gen_evaluate.py --output metrics/gen_eval_report.json || echo "eval script returned non-zero"

      - name: Upload intermediate metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ct-metrics-initial
          path: metrics/gen_eval_report.json

  finetune:
    needs: reproduce
    if: needs.prepare.outputs.do_finetune == 'true'
    runs-on: [self-hosted, gpu]
    timeout-minutes: 1440
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Python (GPU runner)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install GPU deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install accelerate transformers datasets peft || true

      - name: Run finetune
        env:
          HF_TOKEN: ${{ secrets.HF_API_TOKEN }}
        run: |
          python src/finetune.py --output models/gen_model/ || (echo "finetune failed" && exit 1)

      - name: Persist model marker
        run: |
          mkdir -p models/gen_model
          echo "finetune_complete: true" > models/gen_model/FINETUNE_DONE.txt

      - name: Push DVC artifacts (if configured)
        if: ${{ secrets.DVC_REMOTE_URL != '' }}
        run: |
          dvc add models/gen_model || true
          git add models/gen_model .gitignore || true
          git commit -m "Add finetuned model artifacts [skip ci]" || true
          dvc push || echo "dvc push failed"

  post_train_eval:
    needs: [reproduce, finetune]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install mlflow || true

      - name: Pull dvc artifacts
        if: ${{ secrets.DVC_REMOTE_URL != '' }}
        run: |
          dvc pull || true

      - name: Run final evaluation
        run: |
          python src/gen_evaluate.py --output metrics/gen_eval_report.json || echo "eval failed"

      - name: Gate checks
        run: |
          python - <<'PY'
import json,sys
r=json.load(open('metrics/gen_eval_report.json'))
halluc=r.get('hallucination_rate',0.0)
factual=r.get('factuality',1.0)
print("hallucination_rate:",halluc,"factuality:",factual)
if halluc>0.15 or factual<0.7:
    print("GATING FAILED")
    sys.exit(2)
print("GATING PASSED")
PY

      - name: Create release and push (if gating passed)
        if: success()
        run: |
          dvc push || echo "dvc push skipped"
          VERSION="genai-model-$(date +%Y%m%d%H%M)"
          gh release create "$VERSION" --notes-file metrics/gen_eval_report.json || echo "release creation skipped"

      - name: Upload CT artifacts
        uses: actions/upload-artifact@v4
        with:
          name: genai-ct-artifacts
          path: |
            metrics/**
            models/**
            logs/**
